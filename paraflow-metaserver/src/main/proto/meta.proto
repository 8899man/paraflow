syntax = "proto3";

option java_package = "cn.edu.ruc.iir.paraflow.metaserver.proto";
option java_outer_classname = "MetaProto";
option objc_class_prefix = "META";

package meta;

service Meta {
    rpc listDatabases(NoneType) returns (StringListType) {}
    rpc listTables(DbNameParam) returns (StringListType) {}
    rpc getDatabase(DbNameParam) returns (DbModel) {}
    rpc getTable(DbTblParam) returns (TblModel) {}
    rpc getColumn(DbTblColParam) returns (ColModel) {}
    rpc createDatabase(DbModel) returns (StatusType) {}
    rpc createTable(TblModel) returns (StatusType) {}
    rpc deleteDatabase(DbNameParam) returns (StatusType) {}
    rpc deleteTable(DbTblParam) returns (StatusType) {}
    rpc renameDatabase(RenameDbParam) returns (StatusType) {}
    rpc renameTable(RenameTblParam) returns (StatusType) {}
    rpc renameColumn(RenameColParam) returns (StatusType) {}
    rpc createFiber(FiberModel) returns (StatusType) {}
    rpc listFiberValues(FiberModel) returns (LongListType) {}
    rpc addBlockIndex(AddBlockIndexParam) returns (StatusType) {}
    rpc filterBlockPathsByTime(FilterBlockPathsByTimeParam) returns (StringListType) {}
    rpc filterBlockPaths(FilterBlockPathsParam) returns (StringListType) {}
}

// Models

message DbModel {
    string name = 1;
    string locationUri = 2;
    UserModel user = 3;
}

message TblModel {
    DbModel database = 1;
    int64 creationTime = 2;
    int64 lastAccessTime = 3;
    UserModel owner = 4;
    string tableName = 5;
    string tableLocationUri = 6;
    ColumnListType columns = 7;
}

message ColModel {
    string databasename = 1;
    string tablename = 2;
    string colName = 3;
    string dataType = 4;
    int32 colIndex = 5;
}

message UserModel {
    string userName = 1;
    string userPass = 2;
    string roleName = 3;
    int64 creationTime = 4;
    int64 lastVisitTime = 5;
}

message FiberModel {
    DbNameParam database = 1;
    TblNameParam table = 2;
    int64 value = 3;
}

// Customized types

message NoneType {
}

message StringListType {
    repeated string str = 1;
}

message LongListType {
    repeated int64 lon = 1;
}

message ColumnListType {
    repeated ColModel column = 1;
}

message FiberValueType {
    int64 value = 1;
}

message StatusType {
    enum State {
        OK = 0;
        DATABASE_ALREADY_EXISTS = 1;
        DATABASE_NOT_FOUND = 2;
        TABLE_ALREADY_EXISTS = 3;
        TABLE_NOT_FOUND = 4;
        COLUMN_ALREADY_EXISTS = 5;
        COLUMN_NOT_FOUND = 6;
        FIBER_ALREADY_EXISTS = 7;
        BLOCK_INDEX_ERROR = 8;
    }
    State status = 1;
}

// Customized paremeters

message DbNameParam {
    string database = 1;
}

message TblNameParam {
    string table = 1;
}

message ColNameParam {
    string column = 1;
}

message DbTblParam {
    DbNameParam database = 1;
    TblNameParam table = 2;
}

message DbTblColParam {
    DbNameParam database = 1;
    TblNameParam table = 2;
    ColNameParam column = 3;
}

message RenameDbParam {
    string old_name = 1;
    string new_name = 2;
}

message RenameTblParam {
    DbNameParam database = 1;
    string old_name = 2;
    string new_name = 3;
}

message RenameColParam {
    DbNameParam database = 1;
    TblNameParam table = 2;
    string old_name = 3;
    string new_name = 4;
}

message AddBlockIndexParam {
    DbNameParam database = 1;
    TblNameParam table = 2;
    FiberValueType value = 3;
    string begin_time = 4;
    string end_time = 5;
    string path = 6;
}

message FilterBlockPathsByTimeParam {
    DbNameParam database = 1;
    TblNameParam table = 2;
    string timelow = 3;
    string timehigh = 4;
}

message FilterBlockPathsParam {
    DbNameParam database = 1;
    TblNameParam table = 2;
    FiberValueType value = 3;
    string timelow = 4;
    string timehigh = 5;
}
